<!DOCTYPE html>
<html>
<head>
    <title>CRM Data Bridge</title>
    <meta charset="utf-8">
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #status { margin-bottom: 20px; padding: 10px; border-radius: 4px; }
        .loading { background: #e3f2fd; color: #1976d2; }
        .success { background: #e8f5e9; color: #388e3c; }
        .error { background: #ffebee; color: #d32f2f; }
        #data { margin-top: 20px; }
        iframe { width: 100%; height: 200px; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div id="status" class="loading">Loading CRM data via bridge...</div>
    <div id="data"></div>

    <script>
        // CRM Data Bridge - Fetch data from vanguard backend and make it available via postMessage

        function loadCRMViaJSONP() {
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    cleanup();
                    reject(new Error('JSONP timeout'));
                }, 15000);

                const callbackName = 'crmBridge_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);

                const cleanup = () => {
                    clearTimeout(timeoutId);
                    if (window[callbackName]) {
                        delete window[callbackName];
                    }
                    const script = document.getElementById(callbackName);
                    if (script) {
                        document.head.removeChild(script);
                    }
                };

                // Set up global callback
                window[callbackName] = function(data) {
                    cleanup();
                    resolve(data);
                };

                // Create script element for JSONP
                const script = document.createElement('script');
                script.id = callbackName;
                script.src = `/api/vigagency/crm/leads?callback=${callbackName}&format=jsonp&_=${Date.now()}`;

                script.onerror = () => {
                    cleanup();
                    reject(new Error('JSONP script failed to load'));
                };

                document.head.appendChild(script);
            });
        }

        async function fetchCRMData() {
            const statusEl = document.getElementById('status');
            const dataEl = document.getElementById('data');

            try {
                statusEl.textContent = 'Connecting to CRM system via JSONP...';
                statusEl.className = 'loading';

                // Use JSONP to avoid Mixed Content issues
                const data = await loadCRMViaJSONP();

                statusEl.textContent = `✅ Successfully loaded ${data.leads?.length || 0} CRM leads`;
                statusEl.className = 'success';

                // Store data globally for parent window access
                window.crmData = data;

                // Send data to parent window if opened from admin dashboard
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'CRM_DATA',
                        success: true,
                        data: data
                    }, '*');
                }

                // Also make data available as JSONP callback
                if (window.location.hash) {
                    const callback = window.location.hash.substring(1);
                    if (callback && window[callback]) {
                        window[callback](data);
                    }
                }

                dataEl.innerHTML = `
                    <h3>CRM Data Available</h3>
                    <p>Total leads: ${data.leads?.length || 0}</p>
                    <p>Source: ${data.source || 'Unknown'}</p>
                    <p>Fetched: ${data.fetchedAt || new Date().toISOString()}</p>
                    <details>
                        <summary>Raw Data (click to expand)</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                `;

            } catch (error) {
                console.error('CRM Bridge Error:', error);
                statusEl.textContent = `❌ Failed to load CRM data: ${error.message}`;
                statusEl.className = 'error';

                // Send error to parent window
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'CRM_ERROR',
                        success: false,
                        error: error.message
                    }, '*');
                }

                dataEl.innerHTML = `
                    <h3>Connection Failed</h3>
                    <p>Error: ${error.message}</p>
                    <p>This may be due to Mixed Content security restrictions.</p>
                `;
            }
        }

        // Auto-run on load
        window.addEventListener('load', fetchCRMData);

        // Make data available for manual access
        window.getCRMData = () => window.crmData;
    </script>
</body>
</html>