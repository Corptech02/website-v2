<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - Vanguard Insurance Group</title>
    <link rel="stylesheet" href="../css/styles.css?v=12">
    <link rel="stylesheet" href="../css/pages.css?v=12">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f5f7fa;
        }

        /* Keep header navigation spacing consistent with other pages */
        .header .nav-list {
            gap: 2rem;
        }

        .logout-btn-custom {
            background: #e74c3c !important;
            background-image: none !important;
        }

        .logout-btn-custom:hover {
            background: #c0392b !important;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 100px auto 40px;
            padding: 0 20px;
        }

        .dashboard-header {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .dashboard-header h1 {
            font-size: 32px;
            color: var(--dark-blue);
            margin: 0 0 10px 0;
        }

        .dashboard-header p {
            color: #666;
            margin: 0;
            font-size: 16px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark-blue);
            margin: 0;
        }

        .stat-card .stat-label {
            font-size: 14px;
            color: #999;
            margin-top: 5px;
        }

        .policy-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .policy-section h2 {
            font-size: 24px;
            color: var(--dark-blue);
            margin: 0 0 25px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .policy-card {
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .policy-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.1);
        }

        .policy-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .policy-type {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark-blue);
            margin: 0 0 5px 0;
        }

        .policy-number {
            color: #666;
            font-size: 14px;
        }

        .policy-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .policy-status.active {
            background: #d4edda;
            color: #155724;
        }

        .policy-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        .policy-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .policy-detail {
            display: flex;
            flex-direction: column;
        }

        .policy-detail-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .policy-detail-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark-blue);
        }

        .policy-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .policy-btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .policy-btn.primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
        }

        .policy-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
        }

        .policy-btn.secondary {
            background: white;
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .policy-btn.secondary:hover {
            background: var(--primary-blue);
            color: white;
        }

        /* COI Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content.coi-modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .modal-close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
        }

        .policy-info-banner {
            background: #f0f7ff;
            border-left: 4px solid var(--primary-blue);
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 25px;
            color: var(--dark-blue);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--dark-blue);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option span {
            cursor: pointer;
            font-weight: 400;
        }

        .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: flex-end;
        }

        .btn-submit, .btn-cancel {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-submit {
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
        }

        .btn-submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .btn-submit:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .btn-cancel {
            background: white;
            color: #666;
            border: 2px solid #e1e8ed;
        }

        .btn-cancel:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="header" id="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <a href="../index.html">
                        <img src="../images/vanguard-logo.png" alt="Vanguard Insurance Group" class="logo">
                    </a>
                </div>
                <div class="nav-menu" id="navMenu">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../index.html" class="nav-link">Home</a></li>
                        <li class="nav-item dropdown">
                            <a href="#" class="nav-link">Products <i class="fas fa-chevron-down"></i></a>
                            <div class="dropdown-content">
                                <a href="commercial-auto.html">Commercial Auto Insurance</a>
                                <a href="trucking-insurance.html">Trucking Insurance</a>
                                <a href="general-liability.html">General Liability</a>
                                <a href="cargo-insurance.html">Cargo Insurance</a>
                            </div>
                        </li>
                        <li class="nav-item"><a href="../index.html#claims" class="nav-link">Claims</a></li>
                        <li class="nav-item"><a href="../index.html#resources" class="nav-link">Resources</a></li>
                        <li class="nav-item"><a href="../index.html#about" class="nav-link">About</a></li>
                        <li class="nav-item"><a href="../index.html#contact" class="nav-link">Contact</a></li>
                        <li class="nav-item"><a href="policyholder-dashboard.html" class="nav-link">Profile</a></li>
                    </ul>
                </div>
                <div class="nav-actions">
                    <a href="#" class="btn btn-primary logout-btn-custom" id="logoutBtn">Logout</a>
                    <button class="nav-toggle" id="navToggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Dashboard Container -->
    <section class="dashboard-container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <h1 id="welcomeHeader">Welcome back</h1>
            <p>Manage your commercial trucking insurance policies</p>
        </div>

        <!-- My Policies -->
        <div class="policy-section">
            <h2><i class="fas fa-file-contract"></i> My Policies</h2>

            <!-- Policies will be loaded dynamically from API -->
            <div id="policiesContainer">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
                    <p style="margin-top: 20px;">Loading your policies...</p>
                </div>
            </div>
        </div>

    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <img src="../images/vanguard-logo.png" alt="Vanguard Insurance Group" class="footer-logo">
                    <p>Your trusted partner in commercial trucking insurance.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="../index.html#products">Our Products</a></li>
                        <li><a href="quote-commercial-auto.html">Get a Quote</a></li>
                        <li><a href="../index.html#claims">File a Claim</a></li>
                        <li><a href="../index.html#contact">Contact Us</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Insurance Products</h4>
                    <ul>
                        <li><a href="commercial-auto.html">Commercial Auto</a></li>
                        <li><a href="trucking-insurance.html">Trucking Insurance</a></li>
                        <li><a href="general-liability.html">General Liability</a></li>
                        <li><a href="cargo-insurance.html">Cargo Insurance</a></li>
                        <li><a href="workers-comp.html">Workers' Compensation</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact Info</h4>
                    <p>2888 Nationwide Pkwy<br>Brunswick, OH 44212</p>
                    <p>Phone: (330) 460-0872<br>Email: contact@vigagency.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Vanguard Insurance Group. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Cookie Policy</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="../js/main.js?v=20251220"></script>
    <script src="../js/policy-data.js?v=20251231-inactive-policy-fix"></script>
    <script>
        // Simple canvas overlay function for COI emails - COPIED DIRECTLY FROM WORKING ADMIN DASHBOARD
        window.createSimpleCOIWithTextOverlay = async function(coiDocument, holderType, policy) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const img = new Image();
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // Draw the original COI image
                    ctx.drawImage(img, 0, 0);

                    // Set up text styling
                    ctx.fillStyle = '#000000';
                    ctx.font = '14px Arial, sans-serif';
                    ctx.textAlign = 'left';

                    // Certificate holder text position
                    const startX = 50;
                    const startY = 900;

                    if (holderType === 'business') {
                        // Use client information
                        const clientName = policy.insured_name || policy.client_name || 'Unknown Client';
                        ctx.fillText(clientName, startX, startY);
                        console.log('üìù Overlaid business certificate holder:', clientName);
                    } else {
                        // Use third-party information from form fields - need to get from client modal
                        const holderName = document.getElementById('holderName')?.value?.trim() || 'Third Party Holder';
                        const holderAddress = document.getElementById('holderAddress')?.value?.trim() || '';
                        const holderCity = document.getElementById('holderCity')?.value?.trim() || '';

                        ctx.fillText(holderName, startX, startY);
                        if (holderAddress) {
                            ctx.fillText(holderAddress, startX, startY + 20);
                        }
                        if (holderCity) {
                            ctx.fillText(holderCity, startX, startY + 40);
                        }
                        console.log('üìù Overlaid third-party certificate holder:', holderName);
                    }

                    // Add current date overlay in top right
                    const currentDate = new Date().toLocaleDateString();
                    ctx.fillStyle = '#000000';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'left';

                    // Position for date field (top right area of ACORD form)
                    const dateX = 664 * 1.3; // X position from ACORD viewer scaled
                    const dateY = 47 * 1.3; // Y position from ACORD viewer scaled

                    ctx.fillText(currentDate, dateX, dateY + 12); // +12 for baseline adjustment
                    console.log('üìÖ Overlaid current date:', currentDate, 'at position:', dateX, dateY);

                    // Convert canvas to blob
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/png');
                };

                img.src = coiDocument.dataUrl;
            });
        };

        console.log('‚úÖ COI overlay function defined - ready to use');
    </script>
    <script>
        console.log('Dashboard loaded - Version 2.4 with fixed certificate holders and localStorage - 20251230');
        const API_BASE_URL = ''; // Use same ngrok domain (proxy forwards to API server)

        function emailCOI(policyId, policyNumber) {
            // Show COI modal instead of redirecting
            showCOIModal(policyId, policyNumber);
        }

        // COI Modal functionality
        async function showCOIModal(policyId, policyNumber) {
            // Try to get policy by ID first, then by policy number as fallback
            let policy = await window.policyDB.getPolicyById(policyId);
            if (!policy && policyNumber) {
                policy = await window.policyDB.getPolicyByNumber(policyNumber);
                console.log('Policy found by number fallback:', policy?.policy_number);
            }
            if (!policy) {
                alert('Policy not found - ID: ' + policyId + ', Number: ' + policyNumber);
                console.error('Policy lookup failed:', { policyId, policyNumber });
                return;
            }
            console.log('Policy found for COI modal:', policy.policy_number);

            // Create modal HTML
            const modalHTML = `
                <div id="coiModal" class="modal-overlay" onclick="closeCOIModal(event)">
                    <div class="modal-content coi-modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3><i class="fas fa-certificate"></i> Request Certificate of Insurance</h3>
                            <button class="modal-close-btn" onclick="closeCOIModal()">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div class="policy-info-banner">
                                <strong>Policy:</strong> ${policy.policy_number} - ${policy.insured_name}
                            </div>

                            <form id="coiModalForm">
                                <div class="form-group">
                                    <label>Certificate Holder Type</label>
                                    <div class="radio-group">
                                        <label class="radio-option">
                                            <input type="radio" name="holderType" value="self" checked onchange="toggleHolderFields()">
                                            <span>For myself/business</span>
                                        </label>
                                        <label class="radio-option">
                                            <input type="radio" name="holderType" value="third-party" onchange="toggleHolderFields()">
                                            <span>For third-party/subcontractor</span>
                                        </label>
                                    </div>
                                </div>

                                <div id="thirdPartyFields" class="hidden">
                                    <!-- Saved Certificate Holders Button -->
                                    <div style="margin-bottom: 20px; text-align: center;">
                                        <button type="button" onclick="showSavedCertificateHolders()"
                                                style="background: linear-gradient(135deg, #059669, #047857); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2); transition: all 0.3s ease;"
                                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(5, 150, 105, 0.3)'"
                                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(5, 150, 105, 0.2)'">
                                            <i class="fas fa-address-book" style="margin-right: 8px;"></i>
                                            Saved Certificate Holders
                                        </button>
                                    </div>

                                    <div class="form-group">
                                        <label>Certificate Holder Name *</label>
                                        <input type="text" id="holderName" placeholder="Business or individual name">
                                    </div>
                                    <div class="form-group">
                                        <label>Certificate Holder Address *</label>
                                        <input type="text" id="holderAddress" placeholder="Street address">
                                    </div>
                                    <div class="form-group">
                                        <input type="text" id="holderCity" placeholder="City, State ZIP">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <label><strong>Email Recipients</strong></label>
                                        <button type="button" onclick="addCOIEmailRecipient()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            + Add Recipient
                                        </button>
                                    </div>
                                    <div id="coiEmailRecipientsContainer">
                                        <div class="coi-email-recipient-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                                            <input type="email" class="coi-email-recipient" required
                                                   style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                                                   placeholder="recipient@example.com" value="${policy.client_email || ''}">
                                            <button type="button" onclick="removeCOIEmailRecipient(this)"
                                                    style="background: #dc3545; color: white; border: none; padding: 10px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                    <div class="help-text">Click "Add Recipient" to add more email addresses</div>
                                </div>


                                <div class="form-actions">
                                    <button type="button" class="btn-submit" onclick="submitCOIModal()">
                                        <i class="fas fa-envelope"></i> Send Certificate
                                    </button>
                                    <button type="button" class="btn-cancel" onclick="closeCOIModal()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Show modal
            document.getElementById('coiModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function toggleHolderFields() {
            const isThirdParty = document.querySelector('input[name="holderType"]:checked').value === 'third-party';
            const thirdPartyFields = document.getElementById('thirdPartyFields');

            if (isThirdParty) {
                thirdPartyFields.classList.remove('hidden');
                document.getElementById('holderName').required = true;
                document.getElementById('holderAddress').required = true;
            } else {
                thirdPartyFields.classList.add('hidden');
                document.getElementById('holderName').required = false;
                document.getElementById('holderAddress').required = false;
            }
        }

        function closeCOIModal(event) {
            if (event && event.target !== event.currentTarget) return;

            const modal = document.getElementById('coiModal');
            if (modal) {
                modal.remove();
                document.body.style.overflow = '';
            }
        }

        async function submitCOIModal() {
            const form = document.getElementById('coiModalForm');
            const submitBtn = document.querySelector('#coiModal .btn-submit');

            // Get the current policy data
            const policyNumber = localStorage.getItem('vanguard_policy_number');
            const policy = await window.policyDB.getPolicyById(policyNumber);

            if (!policy) {
                alert('Policy data not found. Please refresh the page and try again.');
                return;
            }

            // Get form values
            const holderType = document.querySelector('input[name="holderType"]:checked').value;

            // Collect all email recipients from multiple email fields
            const emailInputs = document.querySelectorAll('.coi-email-recipient');
            const emails = Array.from(emailInputs).map(input => input.value.trim()).filter(email => email);

            if (emails.length === 0) {
                alert('Please enter at least one email address');
                return;
            }

            let certificateHolder = '';

            if (holderType === 'third-party') {
                const holderName = document.getElementById('holderName').value.trim();
                const holderAddress = document.getElementById('holderAddress').value.trim();
                const holderCity = document.getElementById('holderCity').value.trim();

                if (!holderName || !holderAddress) {
                    alert('Please fill in certificate holder name and address');
                    return;
                }

                certificateHolder = holderName + '\n' + holderAddress;
                if (holderCity) {
                    certificateHolder += '\n' + holderCity;
                }
            } else {
                // Use policy holder's information
                certificateHolder = policy.insured_name;
                if (policy.address) {
                    certificateHolder += '\n' + policy.address;
                }
            }

            // Disable button and show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                // Get the COI document
                if (!policy.coiDocuments || policy.coiDocuments.length === 0) {
                    alert('No COI document found for this policy');
                    return;
                }

                const coiDoc = policy.coiDocuments[0];
                console.log('üîç COI document found:', coiDoc);

                // EXACTLY replicate admin dashboard approach
                let modifiedCoiBlob;

                // Use the directly defined overlay function (copied from admin dashboard)
                try {
                    console.log('‚úÖ Using COI overlay function to add certificate holder and date...');
                    modifiedCoiBlob = await window.createSimpleCOIWithTextOverlay(coiDoc, holderType, policy);
                    console.log('üìé COI document modified with text overlay, size:', modifiedCoiBlob.size);
                } catch (error) {
                    console.error('‚ùå Error creating COI with overlay:', error);
                    // Fallback to original document
                    try {
                        const response = await fetch(coiDoc.dataUrl);
                        modifiedCoiBlob = await response.blob();
                        console.log('üìé Fallback: Using original COI document, size:', modifiedCoiBlob.size);
                        alert('Using original COI document due to overlay generation error.');
                    } catch (fallbackError) {
                        console.error('‚ùå Error accessing COI document:', fallbackError);
                        alert('Error accessing COI document. Please try again.');
                        return;
                    }
                }

                // Create FormData for the request (matching admin dashboard format)
                const formData = new FormData();
                formData.append('from', 'contact@vigagency.com');
                formData.append('to', emails.join(', '));
                formData.append('subject', `Certificate of Insurance - ${policy.insured_name} - Policy ${policy.policy_number}`);

                // Create email message
                let emailMessage = `Dear Certificate Holder,

Please find attached your Certificate of Insurance for ${policy.insured_name}.

Policy Number: ${policy.policy_number}
Insured: ${policy.insured_name}
Carrier: ${policy.carrier || 'N/A'}

Certificate Holder:
${certificateHolder}

This certificate serves as evidence of insurance coverage. Please contact us if you have any questions.

Best regards,
VigAgency Team
contact@vigagency.com`;

                formData.append('message', emailMessage);
                formData.append('policyId', policy.id);
                formData.append('attachment', modifiedCoiBlob, `COI_Certificate_${policy.policy_number}.png`);

                console.log('COI FormData prepared for policy:', policy.policy_number, 'with attachment');

                const response = await fetch('/api/coi/send-request', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    alert('Certificate of Insurance sent successfully!\n\n' + (data.message || 'The certificate has been emailed.'));
                    closeCOIModal();
                } else {
                    alert('Error sending COI:\n\n' + (data.error || 'An unexpected error occurred. Please try again.'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-envelope"></i> Send Certificate';
                }

            } catch (error) {
                console.error('COI sending error:', error);
                alert('Connection Error\n\nUnable to connect to the server. Please try again.\n\nError: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-envelope"></i> Send Certificate';
            }
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Fetch and display policies using client-side database
        async function loadPolicies() {
            const token = localStorage.getItem('vanguard_auth_token');
            const isTestMode = localStorage.getItem('vanguard_test_mode') === 'true';
            const policyNumber = localStorage.getItem('vanguard_policy_number');
            const userName = localStorage.getItem('vanguard_user_name');
            const policiesContainer = document.getElementById('policiesContainer');

            console.log('Loading policies from client-side database. Policy:', policyNumber);
            console.log('User name from localStorage:', userName);
            console.log('All localStorage auth data:', {
                logged_in: localStorage.getItem('vanguard_logged_in'),
                policy_number: localStorage.getItem('vanguard_policy_number'),
                user_name: localStorage.getItem('vanguard_user_name'),
                user_email: localStorage.getItem('vanguard_user_email')
            });

            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // Show loading state
            policiesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i><p style="margin-top: 20px;">Loading your policies...</p></div>';

            try {
                // Wait for policy database to be ready if it doesn't exist yet
                if (!window.policyDB) {
                    console.log('‚è≥ Waiting for PolicyDataManager to initialize...');
                    let attempts = 0;
                    while (!window.policyDB && attempts < 50) { // Wait up to 5 seconds
                        await new Promise(resolve => setTimeout(resolve, 100));
                        attempts++;
                    }
                    if (!window.policyDB) {
                        throw new Error('PolicyDataManager failed to initialize');
                    }
                    console.log('‚úÖ PolicyDataManager ready after', attempts * 100, 'ms');
                }

                // Policy data will be loaded via await calls below

                // Debug policy database state
                console.log('üîç Debug PolicyDB state:');
                console.log('  - policyDB exists:', !!window.policyDB);
                console.log('  - getUserPolicies exists:', !!window.policyDB?.getUserPolicies);
                console.log('  - Looking for policy number:', policyNumber);

                // Get user's policies from client-side database
                const userPolicies = await window.policyDB.getUserPolicies(policyNumber);
                console.log('Found policies:', userPolicies ? userPolicies.length : userPolicies);

                // Additional debug info
                if (window.policyDB && window.policyDB.getAllPolicies) {
                    const allPolicies = await window.policyDB.getAllPolicies();
                    console.log('üìä All policies in database:', allPolicies ? allPolicies.length : allPolicies);
                    if (allPolicies && allPolicies.length > 0) {
                        console.log('üîç Sample policy structure:', allPolicies[0]);
                        console.log('üîç Sample policy keys:', Object.keys(allPolicies[0]));
                        const matching = allPolicies.filter(p => p.policy_number === policyNumber || p.id === policyNumber);
                        console.log('üìã Policies matching', policyNumber + ':', matching.length);
                        if (matching.length > 0) {
                            console.log('üîç Matching policy structure:', matching[0]);
                            console.log('üîç Matching policy keys:', Object.keys(matching[0]));
                        }
                    }
                }

                // Update header with user name (get from localStorage or policy data)
                let displayName = userName;
                if (!displayName && userPolicies && userPolicies.length > 0) {
                    displayName = userPolicies[0].insured_name;
                    console.log('Using policy name as fallback:', displayName);
                }
                if (displayName) {
                    document.getElementById('welcomeHeader').textContent = `Welcome back, ${displayName}`;
                    console.log('Updated header with name:', displayName);
                } else {
                    console.warn('No user name found in localStorage or policies');
                }

                if (userPolicies && userPolicies.length > 0) {
                    // Client-side data banner removed per user request

                    // Simulate loading delay for better UX
                    setTimeout(() => {
                        if (userPolicies.length === 1) {
                            // Display single policy
                            displayPolicy(userPolicies[0]);
                        } else {
                            // Display multiple policies
                            displayPolicies(userPolicies);
                        }
                    }, 600);
                } else {
                    policiesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><i class="fas fa-info-circle" style="font-size: 32px;"></i><p style="margin-top: 20px;">No policies found for your account.</p><p style="color: #999; margin-top: 10px;">Contact your agent if you believe this is an error.</p></div>';
                }
            } catch (error) {
                console.error('Error loading policies:', error);
                policiesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;"><i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i><p style="margin-top: 20px;">Error loading policies. Please refresh the page or contact support.</p></div>';
            }
        }

        // Display policies dynamically
        function displayPolicies(policies) {
            const policiesContainer = document.getElementById('policiesContainer');
            policiesContainer.innerHTML = '';

            policies.forEach((policy, index) => {
                const policyCard = document.createElement('div');
                policyCard.className = 'policy-card';

                // Determine icon based on policy type
                let icon = 'fa-file-contract';
                if (policy.type && policy.type.toLowerCase().includes('auto')) {
                    icon = 'fa-truck';
                } else if (policy.type && policy.type.toLowerCase().includes('liability')) {
                    icon = 'fa-shield-alt';
                } else if (policy.type && policy.type.toLowerCase().includes('cargo')) {
                    icon = 'fa-boxes';
                }

                policyCard.innerHTML = `
                    <div class="policy-header">
                        <div class="policy-title">
                            <i class="fas ${icon}"></i>
                            <h3>${policy.type || 'Insurance Policy'}</h3>
                        </div>
                        <span class="policy-status ${policy.status === 'Active' ? 'active' : ''}">${policy.status || 'Active'}</span>
                    </div>
                    <div class="policy-number">Policy #: ${policy.policy_number}</div>
                    <div class="policy-details">
                        <div class="policy-detail">
                            <div class="policy-detail-label">Premium</div>
                            <div class="policy-detail-value">${formatCurrency(policy.premium || 0)}</div>
                        </div>
                        <div class="policy-detail">
                            <div class="policy-detail-label">Effective</div>
                            <div class="policy-detail-value">${formatDate(policy.effective_date)}</div>
                        </div>
                        <div class="policy-detail">
                            <div class="policy-detail-label">Expires</div>
                            <div class="policy-detail-value">${formatDate(policy.expiration_date)}</div>
                        </div>
                        <div class="policy-detail">
                            <div class="policy-detail-label">Carrier</div>
                            <div class="policy-detail-value">${policy.carrier || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="policy-actions">
                        <button class="policy-btn primary" onclick="emailCOI('${policy.id}', '${policy.policy_number}')">
                            <i class="fas fa-envelope"></i> Email COI
                        </button>
                        <button class="policy-btn secondary" onclick="viewCurrentCOI_DEBUG('${policy.id}')">
                            <i class="fas fa-file-pdf"></i> View COI
                        </button>
                    </div>
                `;

                policiesContainer.appendChild(policyCard);
            });
        }

        // Display single policy from API response
        function displayPolicy(policy) {
            const policiesContainer = document.getElementById('policiesContainer');
            policiesContainer.innerHTML = '';

            const policyCard = document.createElement('div');
            policyCard.className = 'policy-card';

            // Default icon for commercial trucking
            const icon = 'fa-truck';

            // Parse premium string (e.g., "$14,628.00" to number)
            let premiumValue = 0;
            if (policy.premium) {
                if (typeof policy.premium === 'string') {
                    premiumValue = parseFloat(policy.premium.replace(/[$,]/g, ''));
                } else {
                    premiumValue = policy.premium;
                }
            }

            policyCard.innerHTML = `
                <div class="policy-card-header">
                    <div>
                        <h3 class="policy-type"><i class="fas ${icon}"></i> Commercial Auto Insurance</h3>
                        <div class="policy-number">Policy #: ${policy.policyNumber || policy.policy_number || 'N/A'}</div>
                    </div>
                    <span class="policy-status ${(policy.policyStatus || policy.status) === 'Active' ? 'active' : 'pending'}">${policy.policyStatus || policy.status || 'Active'}</span>
                </div>
                <div class="policy-details">
                    <div class="policy-detail">
                        <div class="policy-detail-label">Carrier</div>
                        <div class="policy-detail-value">${policy.carrier || 'N/A'}</div>
                    </div>
                    <div class="policy-detail">
                        <div class="policy-detail-label">Effective Date</div>
                        <div class="policy-detail-value">${formatDate(policy.effectiveDate || policy.effective_date)}</div>
                    </div>
                    <div class="policy-detail">
                        <div class="policy-detail-label">Expiration Date</div>
                        <div class="policy-detail-value">${formatDate(policy.expirationDate || policy.expiration_date)}</div>
                    </div>
                </div>
                <div class="policy-actions">
                    <button class="policy-btn primary" onclick="emailCOI('${policy.id}', '${policy.policyNumber || policy.policy_number}')">
                        <i class="fas fa-envelope"></i> Email COI
                    </button>
                    <button class="policy-btn secondary" onclick="viewCurrentCOI_DEBUG('${policy.id}')">
                        <i class="fas fa-file-pdf"></i> View COI
                    </button>
                </div>
            `;

            policiesContainer.appendChild(policyCard);
        }

        // Update dashboard statistics from policies array (disabled - stats removed from UI)
        function updateDashboardStatsFromPolicies(policies) {
            // Stats grid has been removed from the dashboard
            // This function is kept for compatibility but does nothing
            console.log('Stats update skipped - stats grid removed from UI');
        }

        // Update dashboard statistics (disabled - stats removed from UI)
        function updateDashboardStats(summary, policy) {
            // Stats grid has been removed from the dashboard
            // This function is kept for compatibility but does nothing
            console.log('Stats update skipped - stats grid removed from UI');
        }

        // View COI functionality for client dashboard
        window.viewCurrentCOI_DEBUG = async function(policyId) {
            console.log('üîç Client viewCurrentCOI called for policy:', policyId);

            let policy;
            try {
                // Get policy from client-side database (await the async call)
                const allPolicies = await window.policyDB.getAllPolicies();
                console.log('üîç viewCurrentCOI: getAllPolicies returned:', allPolicies?.length, 'policies');
                console.log('üîç viewCurrentCOI: Sample policy structure:', allPolicies?.[0]);

                if (!allPolicies || !Array.isArray(allPolicies)) {
                    console.error('‚ùå viewCurrentCOI: getAllPolicies did not return an array:', allPolicies);
                    alert('Error loading policy data. Please refresh the page.');
                    return;
                }

                // Debug: Check all policies for COI data
                console.log('üîç Checking all policies for COI documents...');
                allPolicies.forEach((p, index) => {
                    const hasCoiDocs = p.coiDocuments && p.coiDocuments.length > 0;
                    console.log(`Policy ${index}:`, {
                        id: p.id,
                        policy_number: p.policy_number,
                        policyNumber: p.policyNumber,
                        hasCoiDocs,
                        coiDocsCount: p.coiDocuments?.length || 0
                    });
                });

                policy = allPolicies.find(p => p.id === policyId || p.policy_number === policyId || p.policyNumber === policyId);
                console.log('üîç Found matching policy:', !!policy, policy ? {
                    id: policy.id,
                    policy_number: policy.policy_number,
                    policyNumber: policy.policyNumber,
                    hasCoiDocs: !!(policy.coiDocuments && policy.coiDocuments.length > 0)
                } : null);

                if (!policy) {
                    console.error('‚ùå viewCurrentCOI: Policy not found with ID/number:', policyId);
                    console.log('üîç Available policies:', allPolicies.map(p => ({id: p.id, policy_number: p.policy_number, policyNumber: p.policyNumber})));
                    alert('Policy not found!');
                    return;
                }
            } catch (error) {
                console.error('‚ùå viewCurrentCOI: Error loading policy:', error);
                alert('Error loading policy data. Please refresh the page.');
                return;
            }

            console.log('üìã Found policy:', policy.policyNumber || policy.policy_number);

            // First check if COI documents exist in the policy data structure (like admin dashboard)
            if (policy.coiDocuments && policy.coiDocuments.length > 0) {
                console.log('‚úÖ Found COI documents in policy data:', policy.coiDocuments.length);
                const coiDoc = policy.coiDocuments[0];

                // Create modal to display the actual COI image
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

                const img = document.createElement('img');
                img.src = coiDoc.dataUrl;
                img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';

                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '√ó';
                closeBtn.style.cssText = 'position: absolute; top: 20px; right: 30px; background: white; border: none; font-size: 30px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 10001;';
                closeBtn.onclick = () => {
                    if (modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                };

                modal.appendChild(img);
                modal.appendChild(closeBtn);
                modal.onclick = (e) => {
                    if (e.target === modal && modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                };

                document.body.appendChild(modal);
                return;
            } else {
                // If no COI documents in client policy, fetch from admin side using policy number
                const lookingFor = policy.policyNumber || policy.policy_number;
                console.log('üîÑ No COI in client data, checking admin data for policy:', lookingFor);

                try {
                    // Try to access admin policies the same way admin dashboard does
                    let adminPolicies = [];

                    // First try to access window.allPolicies if it exists (admin context)
                    if (typeof window !== 'undefined' && window.allPolicies && Array.isArray(window.allPolicies)) {
                        adminPolicies = window.allPolicies;
                        console.log('üîç Using window.allPolicies from admin context:', adminPolicies.length, 'policies');
                    } else {
                        // Fallback to API fetch
                        console.log('üîç window.allPolicies not available, fetching from API...');
                        const adminResponse = await fetch('/api/policies');
                        const adminData = await adminResponse.json();
                        adminPolicies = Array.isArray(adminData) ? adminData : (adminData.policies || []);
                    }

                    console.log('üîç Checking admin policies for COI data. Found', adminPolicies.length, 'admin policies');

                    // Debug admin policies structure
                    if (adminPolicies.length > 0) {
                        console.log('üîç Sample admin policy structure:', adminPolicies[0]);
                        console.log('üîç Sample admin policy keys:', Object.keys(adminPolicies[0]));
                    }

                    // Find matching admin policy
                    console.log('üîç Looking for policy number in admin data:', lookingFor);

                    // Check ALL policies thoroughly for any COI-related data
                    let foundAnyWithCOI = false;
                    adminPolicies.forEach((p, index) => {
                        const policyId = p.policy_number || p.policyNumber || p.id;
                        const hasMatch = policyId === lookingFor || policyId === `policy-${lookingFor}`;
                        const hasCOI = p.coiDocuments && p.coiDocuments.length > 0;

                        if (hasCOI) {
                            foundAnyWithCOI = true;
                            console.log(`üéØ FOUND POLICY WITH COI! Admin policy ${index}:`, {
                                policyId,
                                hasMatch,
                                coiDocsCount: p.coiDocuments?.length || 0
                            });
                        }

                        // Debug ALL fields that might contain COI data for matching policies
                        if (hasMatch) {
                            console.log(`üîç DETAILED DEBUG for matching policy ${index}:`, {
                                policyId,
                                coiDocuments: p.coiDocuments,
                                documents: p.documents,
                                allKeys: Object.keys(p),
                                hasCoiField: 'coiDocuments' in p,
                                hasDocsField: 'documents' in p
                            });

                            // Check every property for anything that might be COI-related
                            Object.keys(p).forEach(key => {
                                if (key.toLowerCase().includes('coi') || key.toLowerCase().includes('doc') || key.toLowerCase().includes('cert')) {
                                    console.log(`üîç Potential COI field "${key}":`, p[key]);
                                }
                            });
                        }

                        if (hasMatch || hasCOI) {
                            console.log(`üîç Admin policy ${index}:`, {
                                policyId,
                                hasMatch,
                                hasCOI,
                                coiDocsCount: p.coiDocuments?.length || 0,
                                hasDocuments: !!p.documents,
                                documentsType: typeof p.documents
                            });

                            // Also check if COI is in documents field
                            if (p.documents && Object.keys(p.documents).length > 0) {
                                console.log(`üîç Admin policy ${index} documents:`, p.documents);
                            }
                        }
                    });

                    if (foundAnyWithCOI) {
                        console.log('‚úÖ Found at least one policy with COI documents in the admin data!');
                    } else {
                        console.log('‚ùå No policies with COI documents found in admin data');
                    }

                    // Try multiple matching strategies - prioritize the working admin format
                    let adminPolicy = adminPolicies.find(p => {
                        // Match by policy_number field (this is what admin uses: policy_number: '864709702')
                        if ((p.policy_number || p.policyNumber) === lookingFor) {
                            return true;
                        }
                        // Match by ID with or without policy- prefix
                        if (p.id === lookingFor || p.id === `policy-${lookingFor}`) {
                            return true;
                        }
                        // Fallback: check if either field contains our number
                        const policyId = p.policy_number || p.policyNumber || p.id || '';
                        return policyId === lookingFor || policyId.includes(lookingFor);
                    });

                    console.log('üîç Found matching admin policy:', !!adminPolicy, adminPolicy ? {
                        id: adminPolicy.id,
                        policy_number: adminPolicy.policy_number,
                        policyNumber: adminPolicy.policyNumber,
                        hasCOI: !!(adminPolicy.coiDocuments && adminPolicy.coiDocuments.length > 0)
                    } : null);

                    // If no match found, but we know COI exists, try to find ANY policy with COI that contains our policy number
                    if (!adminPolicy || !adminPolicy.coiDocuments) {
                        console.log('üîç No direct match found, searching for any policy with COI containing our policy number...');
                        adminPolicy = adminPolicies.find(p => {
                            if (!p.coiDocuments || p.coiDocuments.length === 0) return false;

                            const policyId = p.policy_number || p.policyNumber || p.id || '';
                            const coiDoc = p.coiDocuments[0];

                            // Check if policy ID contains our number or COI name contains our number
                            const policyMatches = policyId && policyId.includes(lookingFor);
                            const coiMatches = coiDoc.name && coiDoc.name.includes(lookingFor);

                            if (policyMatches || coiMatches) {
                                console.log('üéØ Found COI match!', {
                                    policyId,
                                    coiName: coiDoc.name,
                                    policyMatches,
                                    coiMatches
                                });
                                return true;
                            }
                            return false;
                        });
                    }

                    console.log('üîç Found matching admin policy:', !!adminPolicy);
                    if (adminPolicy) {
                        console.log('üîç Admin policy COI documents:', adminPolicy.coiDocuments?.length || 0);
                        console.log('üîç Admin policy documents field:', adminPolicy.documents);
                        console.log('üîç Admin policy keys:', Object.keys(adminPolicy));
                    }

                    // Check for COI in coiDocuments field
                    if (adminPolicy && adminPolicy.coiDocuments && adminPolicy.coiDocuments.length > 0) {
                        console.log('‚úÖ Found COI in admin policy data!');
                        const coiDoc = adminPolicy.coiDocuments[0];

                        // Create modal to display the actual COI image
                        const modal = document.createElement('div');
                        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

                        const img = document.createElement('img');
                        img.src = coiDoc.dataUrl;
                        img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';

                        const closeBtn = document.createElement('button');
                        closeBtn.innerHTML = '√ó';
                        closeBtn.style.cssText = 'position: absolute; top: 20px; right: 30px; background: white; border: none; font-size: 30px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 10001;';
                        closeBtn.onclick = () => {
                            if (modal && modal.parentNode) {
                                modal.parentNode.removeChild(modal);
                            }
                        };

                        modal.appendChild(img);
                        modal.appendChild(closeBtn);
                        modal.onclick = (e) => {
                            if (e.target === modal && modal.parentNode) {
                                modal.parentNode.removeChild(modal);
                            }
                        };

                        document.body.appendChild(modal);
                        return;
                    } else if (adminPolicy && adminPolicy.documents) {
                        // Check if COI is stored in documents field
                        console.log('üîç Checking documents field for COI...');
                        let coiDoc = null;

                        // documents might be an array or object with COI data
                        if (Array.isArray(adminPolicy.documents)) {
                            coiDoc = adminPolicy.documents.find(doc => doc.type === 'coi' || doc.name?.includes('ACORD') || doc.name?.includes('COI'));
                        } else if (adminPolicy.documents && typeof adminPolicy.documents === 'object') {
                            // Check for COI in object properties
                            Object.keys(adminPolicy.documents).forEach(key => {
                                const doc = adminPolicy.documents[key];
                                if (doc && (doc.type === 'coi' || doc.name?.includes('ACORD') || doc.name?.includes('COI'))) {
                                    coiDoc = doc;
                                }
                            });
                        }

                        if (coiDoc && coiDoc.dataUrl) {
                            console.log('‚úÖ Found COI in documents field!');

                            // Create modal to display the actual COI image
                            const modal = document.createElement('div');
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

                            const img = document.createElement('img');
                            img.src = coiDoc.dataUrl;
                            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';

                            const closeBtn = document.createElement('button');
                            closeBtn.innerHTML = '√ó';
                            closeBtn.style.cssText = 'position: absolute; top: 20px; right: 30px; background: white; border: none; font-size: 30px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 10001;';
                            closeBtn.onclick = () => {
                                if (modal && modal.parentNode) {
                                    modal.parentNode.removeChild(modal);
                                }
                            };

                            modal.appendChild(img);
                            modal.appendChild(closeBtn);
                            modal.onclick = (e) => {
                                if (e.target === modal && modal.parentNode) {
                                    modal.parentNode.removeChild(modal);
                                }
                            };

                            document.body.appendChild(modal);
                            return;
                        } else {
                            console.log('‚ùå No COI found in documents field either');
                        }
                    } else {
                        console.log('‚ùå No COI found in admin policy data either');
                    }
                } catch (error) {
                    console.error('‚ùå Error fetching admin policy data:', error);
                }

                // If all else fails, try to fetch COI directly using different COI endpoints
                try {
                    console.log('üîÑ Trying direct COI fetch for policy:', lookingFor);

                    // Try multiple possible COI endpoints
                    const possibleEndpoints = [
                        `/api/coi/${lookingFor}`,
                        `/api/get-coi-form/${lookingFor}`,
                        `/api/policies/${lookingFor}/coi`,
                        `/api/policies/policy-${lookingFor}/coi`
                    ];

                    let coiData = null;
                    for (const endpoint of possibleEndpoints) {
                        try {
                            console.log('üîÑ Trying endpoint:', endpoint);
                            const coiResponse = await fetch(endpoint);
                            if (coiResponse.ok) {
                                coiData = await coiResponse.json();
                                console.log('‚úÖ Found COI via endpoint:', endpoint, coiData);
                                break;
                            } else {
                                console.log('‚ùå Endpoint failed:', endpoint, coiResponse.status);
                            }
                        } catch (e) {
                            console.log('‚ùå Endpoint error:', endpoint, e.message);
                        }
                    }

                    if (coiData && coiData.dataUrl) {
                            // Create modal to display the COI image
                            const modal = document.createElement('div');
                            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

                            const img = document.createElement('img');
                            img.src = coiData.dataUrl;
                            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);';

                            const closeBtn = document.createElement('button');
                            closeBtn.innerHTML = '√ó';
                            closeBtn.style.cssText = 'position: absolute; top: 20px; right: 30px; background: white; border: none; font-size: 30px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 10001;';
                            closeBtn.onclick = () => {
                                if (modal && modal.parentNode) {
                                    modal.parentNode.removeChild(modal);
                                }
                            };

                            modal.appendChild(img);
                            modal.appendChild(closeBtn);
                            modal.onclick = (e) => {
                                if (e.target === modal && modal.parentNode) {
                                    modal.parentNode.removeChild(modal);
                                }
                            };

                            document.body.appendChild(modal);
                            return;
                        } else {
                        console.log('‚ùå All COI endpoints failed');
                    }
                } catch (error) {
                    console.log('‚ùå Direct COI fetch failed:', error.message);
                }
            }

            // Fallback: Check if there's a saved COI for this policy in localStorage
            console.log('üîç No COI documents in policy data, checking localStorage...');
            const savedCOI = localStorage.getItem(`coi_data_${policyId}`);

            if (!savedCOI) {
                console.log('‚ùå No COI found in localStorage either');
                alert('No COI document found for this policy.\n\nThe COI will be available after your agent generates one.');
                return;
            }

            let coiData;
            try {
                coiData = JSON.parse(savedCOI);
            } catch (error) {
                console.error('Error parsing saved COI data:', error);
                alert('Error loading COI document. Please contact support.');
                return;
            }

            // Create modal to display COI
            const modal = document.createElement('div');
            modal.id = 'coiViewer';
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="add-policy-modal" style="max-width: 800px; max-height: 90vh;">
                    <div class="modal-header">
                        <h2><i class="fas fa-file-pdf"></i> COI Document - Policy ${policy.policy_number}</h2>
                        <button class="modal-close" onclick="closeCOIViewer()">√ó</button>
                    </div>
                    <div style="padding: 20px; max-height: calc(90vh - 100px); overflow-y: auto;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h3 style="margin: 0; color: #2c5282;">Certificate Information</h3>
                                <span style="background: #e6fffa; color: #234e52; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;">
                                    Generated: ${coiData.generatedDate || 'Date not available'}
                                </span>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                <div><strong>Policy Number:</strong> ${policy.policy_number}</div>
                                <div><strong>Insured:</strong> ${policy.insured_name || policy.client_name}</div>
                                <div><strong>Certificate Type:</strong> ${coiData.certificateType || 'Standard'}</div>
                                <div><strong>Status:</strong> <span style="color: #059669; font-weight: 500;">Active</span></div>
                            </div>
                        </div>

                        <div style="border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; background: white;">
                            <div id="coiViewerContainer" style="width: 100%; min-height: 600px; position: relative;">
                                <div style="display: flex; align-items: center; justify-content: center; height: 600px; color: #666;">
                                    <div style="text-align: center;">
                                        <i class="fas fa-file-pdf" style="font-size: 48px; color: #e53e3e; margin-bottom: 16px;"></i>
                                        <h3>Certificate of Insurance</h3>
                                        <p>Policy: ${policy.policy_number}</p>
                                        <p style="margin-top: 20px; font-size: 14px;">
                                            Document generated on: ${coiData.generatedDate || 'Date not available'}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 8px; border-left: 4px solid #3182ce;">
                            <h4 style="margin: 0 0 10px 0; color: #2d3748; font-size: 16px;">About This Certificate</h4>
                            <p style="margin: 0; color: #4a5568; font-size: 14px; line-height: 1.5;">
                                This Certificate of Insurance shows that you have active coverage. You can download or share this document
                                as proof of insurance when required by clients, vendors, or regulatory authorities.
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        };

        // Close COI viewer modal
        window.closeCOIViewer = function() {
            const modal = document.getElementById('coiViewer');
            if (modal) {
                document.body.removeChild(modal);
            }
        };


        // Handle logout button on dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is logged in
            const isLoggedIn = localStorage.getItem('vanguard_logged_in') === 'true';
            const token = localStorage.getItem('vanguard_auth_token');
            const isAdmin = localStorage.getItem('vanguard_admin_mode') === 'true';

            console.log('üîç POLICYHOLDER DASHBOARD DEBUG:');
            console.log('  - isLoggedIn:', isLoggedIn);
            console.log('  - token:', token);
            console.log('  - isAdmin:', isAdmin);
            console.log('  - vanguard_admin_mode value:', localStorage.getItem('vanguard_admin_mode'));

            // Redirect admin users to admin dashboard
            if (isAdmin) {
                console.log('üö™ REDIRECTING TO ADMIN: Admin flag detected, redirecting to admin dashboard');
                window.location.href = 'admin-dashboard.html';
                return;
            } else {
                console.log('‚úÖ CLIENT ACCESS: No admin flag detected, staying in policyholder dashboard');
            }

            if (!isLoggedIn || !token) {
                window.location.href = 'login.html';
                return;
            }

            // Load policies from API
            loadPolicies();

            // Handle logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Clear login state
                    localStorage.removeItem('vanguard_logged_in');
                    localStorage.removeItem('vanguard_user_name');
                    localStorage.removeItem('vanguard_policy_number');
                    localStorage.removeItem('vanguard_auth_token');
                    localStorage.removeItem('vanguard_test_mode');

                    // Redirect to login
                    window.location.href = 'login.html';
                });
            }
        });

        // === CERTIFICATE HOLDERS FUNCTIONALITY ===

        window.savedCertificateHolders = window.savedCertificateHolders || [];

        // Global certificate holders (always shown first) - SAME AS ADMIN
        const globalCertificateHolders = [
            {
                name: "Highway App, Inc.",
                address: "5931 Greenville Ave, Unit #5620",
                cityStateZip: "Dallas, TX 75206",
                email: "coi@highway.com",
                isGlobal: true
            },
            {
                name: "Registry Monitoring Insurance Services, Inc",
                address: "1444 S Entertainment Ave, Ste 110",
                cityStateZip: "Boise, ID 83709",
                email: "transportation@rmis.com",
                isGlobal: true
            },
            {
                name: "DAT Solutions",
                address: "8405 SW Nimbus Ave",
                cityStateZip: "Beaverton, OR 97008",
                email: "certs@dat.com",
                isGlobal: true
            },
            {
                name: "ASSURE ASSIST",
                address: "543 Country Club Dr, Unit B338",
                cityStateZip: "Simi Valley, CA 93065",
                email: "coi@assureassist.com",
                isGlobal: true,
                id: "assure-assist-2025-" + Date.now()
            }
        ];

        // Show saved certificate holders popup
        window.showSavedCertificateHolders = function() {
            console.log('üè¢ Opening saved certificate holders popup');

            // Function to filter certificate holders based on search
            const filterHolders = (searchTerm = '') => {
                const term = searchTerm.toLowerCase();
                const allHolders = [...globalCertificateHolders, ...window.savedCertificateHolders];

                if (!term) return allHolders;

                return allHolders.filter(holder =>
                    holder.name.toLowerCase().includes(term) ||
                    holder.address.toLowerCase().includes(term) ||
                    holder.cityStateZip.toLowerCase().includes(term) ||
                    holder.email.toLowerCase().includes(term)
                );
            };

            // Function to render certificate holders
            const renderHolders = (holders) => {
                const globalHolders = holders.filter(h => h.isGlobal);
                const regularHolders = holders.filter(h => !h.isGlobal);

                return `
                    ${globalHolders.length > 0 ? `
                        <div style="margin-bottom: 25px;">
                            <h3 style="margin: 0 0 15px 0; color: #2196f3; border-bottom: 2px solid #e3f2fd; padding-bottom: 8px; display: flex; align-items: center;">
                                <i class="fas fa-globe" style="margin-right: 8px; color: #2196f3;"></i>
                                Global Certificate Holders
                            </h3>
                            ${globalHolders.map(renderHolderCard).join('')}
                        </div>
                    ` : ''}
                    ${regularHolders.length > 0 ? `
                        <div>
                            <h3 style="margin: 0 0 15px 0; color: #059669; border-bottom: 2px solid #e8f5e8; padding-bottom: 8px; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 8px; color: #059669;"></i>
                                Saved Certificate Holders
                            </h3>
                            ${regularHolders.map(renderHolderCard).join('')}
                        </div>
                    ` : ''}
                    ${holders.length === 0 ? `
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <p style="margin: 0; font-size: 16px;">No certificate holders found</p>
                        </div>
                    ` : ''}
                `;
            };

            // Function to render individual holder card
            const renderHolderCard = (holder) => `
                <div style="border: 2px solid #e5e7eb; border-radius: 8px; padding: 16px; background: white; margin-bottom: 12px; position: relative; transition: all 0.3s ease;">
                    ${holder.isGlobal ? `
                        <div style="position: absolute; top: 8px; right: 8px; background: #2196f3; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; z-index: 10;">
                            <i class="fas fa-globe" style="margin-right: 4px;"></i>GLOBAL
                        </div>
                    ` : `
                        <div style="position: absolute; top: 8px; right: 8px; z-index: 10;">
                            <button onclick="event.stopPropagation(); deleteCertificateHolder('${holder.name.replace(/'/g, "\\'")}', '${holder.email}')"
                                    style="background: #dc2626; color: white; border: none; padding: 6px 8px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: background 0.2s ease;"
                                    onmouseover="this.style.background='#b91c1c'"
                                    onmouseout="this.style.background='#dc2626'"
                                    title="Delete certificate holder">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `}
                    <div onclick="selectCertificateHolder('${holder.name.replace(/'/g, "\\'")}', '${holder.address}', '${holder.cityStateZip}', '${holder.email}')"
                         style="cursor: pointer; padding-right: ${holder.isGlobal ? '60px' : '50px'};"
                         onmouseover="this.closest('div').style.borderColor='#059669'; this.closest('div').style.backgroundColor='#f0fdf4';"
                         onmouseout="this.closest('div').style.borderColor='#e5e7eb'; this.closest('div').style.backgroundColor='white';">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 8px 0; color: #1f2937; font-size: 16px; font-weight: 600;">
                                    ${holder.name}
                                </h4>
                                <p style="margin: 0 0 4px 0; color: #4b5563; font-size: 14px;">
                                    ${holder.address}
                                </p>
                                <p style="margin: 0 0 4px 0; color: #4b5563; font-size: 14px;">
                                    ${holder.cityStateZip}
                                </p>
                                <p style="margin: 0; color: #059669; font-size: 14px; font-weight: 500;">
                                    ${holder.email}
                                </p>
                            </div>
                            <div style="color: #059669; font-size: 18px; margin-top: 8px;">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Create modal HTML with search functionality
            const modalHTML = `
                <div id="certificateHoldersPopup" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 20000;">
                    <div style="background: white; border-radius: 12px; width: 90%; max-width: 600px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
                        <!-- Header -->
                        <div style="background: linear-gradient(135deg, #059669, #047857); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: white;">
                                <i class="fas fa-address-book" style="margin-right: 8px;"></i>
                                Certificate Holders
                            </h3>
                            <button onclick="closeCertificateHoldersPopup()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">√ó</button>
                        </div>

                        <!-- Content -->
                        <div style="padding: 20px; flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                            <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px;">
                                Click on a certificate holder to auto-populate the form fields.
                            </p>

                            <!-- Search Box -->
                            <div style="margin-bottom: 20px; position: relative;">
                                <input type="text" id="certificateHolderSearch" placeholder="Search certificate holders..."
                                       style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;"
                                       oninput="updateCertificateHoldersDisplay(this.value)">
                                <i class="fas fa-search" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #6b7280;"></i>
                            </div>

                            <!-- Certificate Holders List -->
                            <div id="certificateHoldersContainer" style="flex: 1; overflow-y: auto;">
                                ${renderHolders(filterHolders())}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            // Make update function available globally for search
            window.updateCertificateHoldersDisplay = (searchTerm) => {
                const filteredHolders = filterHolders(searchTerm);
                const holdersContainer = document.getElementById('certificateHoldersContainer');
                if (holdersContainer) {
                    holdersContainer.innerHTML = renderHolders(filteredHolders);
                }
            };

            // Focus search input after modal loads
            setTimeout(() => {
                const searchInput = document.getElementById('certificateHolderSearch');
                if (searchInput) searchInput.focus();
            }, 100);
        };

        // Function to select and populate certificate holder information
        window.selectCertificateHolder = function(name, address, cityStateZip, email) {
            console.log('üìù Populating certificate holder:', name);

            // Populate the form fields - using client dashboard field IDs
            const nameField = document.getElementById('holderName');
            const addressField = document.getElementById('holderAddress');
            const cityField = document.getElementById('holderCity');

            if (nameField) nameField.value = name;
            if (addressField) addressField.value = address;
            if (cityField) cityField.value = cityStateZip;

            // Add email to recipients using the multiple email system
            addCOIEmailRecipientWithValue(email);

            // Close the popup
            closeCertificateHoldersPopup();

            // Certificate holder information populated (removed alert popup)
        };

        // Function to close certificate holders popup
        window.closeCertificateHoldersPopup = function() {
            const popup = document.getElementById('certificateHoldersPopup');
            if (popup) {
                popup.remove();
            }
        };

        // Function to delete a saved certificate holder (localStorage)
        window.deleteCertificateHolder = function(holderName, holderEmail) {
            console.log('üóëÔ∏è Attempting to delete certificate holder:', holderName, holderEmail);

            // Confirm deletion
            if (!confirm(`Are you sure you want to delete "${holderName}"?`)) {
                console.log('üö´ Delete cancelled by user');
                return;
            }

            // Remove from saved holders array
            const initialCount = window.savedCertificateHolders.length;
            window.savedCertificateHolders = window.savedCertificateHolders.filter(holder =>
                !(holder.name === holderName && holder.email === holderEmail)
            );

            const finalCount = window.savedCertificateHolders.length;
            const deleted = initialCount > finalCount;

            if (deleted) {
                // Save to localStorage
                try {
                    localStorage.setItem('vigagency_saved_certificate_holders', JSON.stringify(window.savedCertificateHolders));
                    console.log('‚úÖ Certificate holder deleted and localStorage updated:', holderName);

                    // Refresh the popup display
                    const searchInput = document.getElementById('certificateHolderSearch');
                    const searchTerm = searchInput ? searchInput.value : '';
                    window.updateCertificateHoldersDisplay(searchTerm);

                } catch (error) {
                    console.error('‚ùå Failed to update localStorage after deletion:', error);
                    alert('Failed to delete certificate holder. Please try again.');
                }
            }
        };

        // Load saved certificate holders from localStorage (shared with admin)
        window.loadSavedCertificateHolders = function() {
            try {
                const saved = localStorage.getItem('vigagency_saved_certificate_holders');
                if (saved) {
                    window.savedCertificateHolders = JSON.parse(saved);
                    console.log('‚úÖ Loaded', window.savedCertificateHolders.length, 'saved certificate holders from localStorage');
                } else {
                    window.savedCertificateHolders = [];
                    console.log('‚ÑπÔ∏è No saved certificate holders found in localStorage');
                }
            } catch (error) {
                console.error('‚ùå Failed to load saved certificate holders:', error);
                window.savedCertificateHolders = [];
            }
        };

        // Load saved holders on page load
        window.loadSavedCertificateHolders();

        // Functions for managing multiple email recipients in COI modal
        window.addCOIEmailRecipient = function() {
            const container = document.getElementById('coiEmailRecipientsContainer');
            if (!container) return;

            const newRow = document.createElement('div');
            newRow.className = 'coi-email-recipient-row';
            newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
            newRow.innerHTML = `
                <input type="email" class="coi-email-recipient" required
                       style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                       placeholder="recipient@example.com">
                <button type="button" onclick="removeCOIEmailRecipient(this)"
                        style="background: #dc3545; color: white; border: none; padding: 10px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Remove
                </button>
            `;
            container.appendChild(newRow);
        };

        window.removeCOIEmailRecipient = function(button) {
            const container = document.getElementById('coiEmailRecipientsContainer');
            if (!container) return;

            const rows = container.querySelectorAll('.coi-email-recipient-row');
            if (rows.length > 1) {
                button.parentElement.remove();
            } else {
                // Clear the value of the last remaining input instead of removing it
                const input = button.parentElement.querySelector('.coi-email-recipient');
                if (input) input.value = '';
            }
        };

        window.addCOIEmailRecipientWithValue = function(email) {
            const container = document.getElementById('coiEmailRecipientsContainer');
            if (!container) return;

            // Check if email already exists in any input
            const existingInputs = container.querySelectorAll('.coi-email-recipient');
            for (let input of existingInputs) {
                if (input.value.trim() === email.trim()) {
                    console.log('Email already exists:', email);
                    return; // Email already exists, don't add duplicate
                }
            }

            // Check if there's an empty input field to use
            for (let input of existingInputs) {
                if (!input.value.trim()) {
                    input.value = email;
                    console.log('Added email to empty field:', email);
                    return;
                }
            }

            // If all inputs are filled, create a new row
            const newRow = document.createElement('div');
            newRow.className = 'coi-email-recipient-row';
            newRow.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
            newRow.innerHTML = `
                <input type="email" class="coi-email-recipient" required
                       style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px;"
                       placeholder="recipient@example.com" value="${email}">
                <button type="button" onclick="removeCOIEmailRecipient(this)"
                        style="background: #dc3545; color: white; border: none; padding: 10px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                    Remove
                </button>
            `;
            container.appendChild(newRow);
            console.log('Added email to new field:', email);
        };
    </script>
</body>
</html>
