<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Certificate of Insurance - Vanguard Insurance Group</title>
    <link rel="stylesheet" href="../css/styles.css?v=11">
    <link rel="stylesheet" href="../css/pages.css?v=11">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f5f7fa;
        }

        .coi-container {
            max-width: 900px;
            margin: 100px auto 40px;
            padding: 0 20px;
        }

        .policy-info {
            background: var(--primary-blue);
            color: white;
            padding: 20px 30px;
            border-radius: 12px 12px 0 0;
            margin-bottom: 0;
        }

        .policy-info h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .policy-info h2 span {
            color: white;
        }

        .coi-form-container {
            background: white;
            border-radius: 0 0 12px 12px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .coi-header {
            margin-bottom: 30px;
        }

        .coi-header h1 {
            font-size: 28px;
            color: var(--dark-blue);
            margin: 0 0 15px 0;
        }

        .coi-header p {
            color: #666;
            line-height: 1.6;
            margin: 0;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            font-size: 18px;
            color: var(--dark-blue);
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section h3 i {
            color: #999;
            font-size: 16px;
        }

        .form-question {
            margin-bottom: 20px;
        }

        .form-question label {
            display: block;
            font-weight: 600;
            color: var(--dark-blue);
            margin-bottom: 10px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 400;
        }

        .info-box {
            background: #f0f7ff;
            border-left: 4px solid var(--primary-blue);
            padding: 15px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info-box h4 {
            margin: 0 0 10px 0;
            color: var(--dark-blue);
            font-size: 16px;
        }

        .info-box p {
            margin: 5px 0;
            color: #555;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--dark-blue);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .form-group .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-submit {
            padding: 14px 30px;
            background: linear-gradient(135deg, var(--primary-blue), var(--dark-blue));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 102, 204, 0.4);
        }

        .btn-cancel {
            padding: 14px 30px;
            background: white;
            color: #666;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-cancel:hover {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .contact-help {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }

        .contact-help h4 {
            margin: 0 0 15px 0;
            color: var(--dark-blue);
        }

        .contact-help .contact-info {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .contact-help .contact-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #555;
        }

        .contact-help .contact-item i {
            color: var(--primary-blue);
        }

        .hidden {
            display: none !important;
        }

        .subcontractor-fields {
            margin-top: 20px;
        }

        .info-tooltip {
            position: relative;
            display: inline-block;
        }

        .info-tooltip i {
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }

        .info-tooltip i:hover {
            color: var(--primary-blue);
        }

        .tooltip-popup {
            position: absolute;
            top: 30px;
            left: 0;
            background: #f8f9fa;
            border: 1px solid #e1e8ed;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 350px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }

        .tooltip-popup.show {
            display: block;
        }

        .tooltip-popup p {
            margin: 0;
            color: #555;
            font-size: 14px;
            line-height: 1.5;
        }

        .tooltip-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 24px;
            height: 24px;
        }

        .tooltip-close:hover {
            color: #333;
        }

        .form-question {
            margin-top: 25px;
        }

        .btn-add-recipient {
            background: white;
            color: var(--primary-blue);
            border: 2px dashed var(--primary-blue);
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-add-recipient:hover {
            background: var(--primary-blue);
            color: white;
            border-style: solid;
        }

        .btn-add-recipient.hidden {
            display: none;
        }

        .additional-email-group {
            position: relative;
            margin-top: 15px;
        }

        .btn-remove-recipient {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-remove-recipient:hover {
            background: #c0392b;
            transform: translateY(-50%) scale(1.1);
        }

        .additional-email-group input {
            padding-right: 50px;
        }
    </style>
</head>
<body>
    <!-- Header Navigation -->
    <header class="header" id="header">
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-brand">
                    <a href="../index.html">
                        <img src="../images/vanguard-logo.png" alt="Vanguard Insurance Group" class="logo">
                    </a>
                </div>
                <div class="nav-menu" id="navMenu">
                    <ul class="nav-list">
                        <li class="nav-item"><a href="../index.html" class="nav-link">Home</a></li>
                        <li class="nav-item dropdown">
                            <a href="#" class="nav-link">Products <i class="fas fa-chevron-down"></i></a>
                            <div class="dropdown-content">
                                <a href="commercial-auto.html">Commercial Auto Insurance</a>
                                <a href="trucking-insurance.html">Trucking Insurance</a>
                                <a href="general-liability.html">General Liability</a>
                                <a href="cargo-insurance.html">Cargo Insurance</a>
                            </div>
                        </li>
                        <li class="nav-item"><a href="../index.html#claims" class="nav-link">Claims</a></li>
                        <li class="nav-item"><a href="../index.html#resources" class="nav-link">Resources</a></li>
                        <li class="nav-item"><a href="../index.html#about" class="nav-link">About</a></li>
                        <li class="nav-item"><a href="../index.html#contact" class="nav-link">Contact</a></li>
                        <li class="nav-item"><a href="policyholder-dashboard.html" class="nav-link">Profile</a></li>
                    </ul>
                </div>
                <div class="nav-actions">
                    <a href="#" class="btn btn-primary logout-btn-dynamic" id="logoutBtn">Logout</a>
                    <button class="nav-toggle" id="navToggle">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- COI Request Container -->
    <section class="coi-container">
        <div class="policy-info">
            <h2><i class="fas fa-file-certificate"></i> Policy #: <span id="policyNumber"></span></h2>
        </div>

        <div class="coi-form-container">
            <div class="coi-header">
                <h1>Get a Certificate of Insurance (COI)</h1>
                <p>
                    Complete the form below to obtain a Certificate of Insurance for your policy when requested by a client or customer.
                    This certificate will include: name and address of the insured, limits of the policy, and name and address of the certificate holder.
                </p>
            </div>

            <form id="coiForm" onsubmit="submitCOIRequest(event)">
                <!-- Certificate Holder Information -->
                <div class="form-section">
                    <h3>
                        Certificate Holder Information
                        <span class="info-tooltip">
                            <i class="fas fa-question-circle" onclick="toggleTooltip()"></i>
                            <div class="tooltip-popup" id="holderTooltip">
                                <button class="tooltip-close" onclick="closeTooltip()">&times;</button>
                                <p>The certificate holder is the individual or business that is requiring you to provide a Certificate of Insurance.</p>
                            </div>
                        </span>
                    </h3>

                    <div class="form-question">
                        <label>Do you need a certificate for a subcontractor or third-party vendor?</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" id="vendor-yes" name="isVendor" value="yes" onchange="toggleVendorFields()">
                                <label for="vendor-yes">Yes</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" id="vendor-no" name="isVendor" value="no" checked onchange="toggleVendorFields()">
                                <label for="vendor-no">No</label>
                            </div>
                        </div>
                    </div>

                    <!-- Subcontractor Fields (shown when Yes is selected) -->
                    <div id="subcontractorFields" class="subcontractor-fields hidden">
                        <div class="form-group">
                            <label for="subcontractorName">Subcontractor/Third-Party Business Name *</label>
                            <input type="text" id="subcontractorName" name="subcontractorName" placeholder="Individual or business name">
                        </div>

                        <div class="form-group">
                            <label for="subcontractorStreet">Subcontractor/Third-Party Business Address *</label>
                            <input type="text" id="subcontractorStreet" name="subcontractorStreet" placeholder="Street address">
                        </div>

                        <div class="form-group">
                            <input type="text" id="subcontractorUnit" name="subcontractorUnit" placeholder="Apartment, suite, unit, building, floor, c/o, etc.">
                        </div>

                        <div class="form-group">
                            <input type="text" id="subcontractorZip" name="subcontractorZip" placeholder="ZIP Code">
                            <div class="help-text">ZIP Code can be 5-9 numbers (example: 80301-1000)</div>
                        </div>

                        <div class="form-group">
                            <input type="text" id="subcontractorCity" name="subcontractorCity" placeholder="City">
                        </div>

                        <div class="form-group">
                            <input type="text" id="subcontractorState" name="subcontractorState" placeholder="State">
                        </div>
                    </div>
                </div>

                <!-- Your Contact Information (hidden when Yes is selected) -->
                <div class="form-section" id="contactInfoSection">
                    <h3>Your Contact Information</h3>

                    <div class="info-box">
                        <h4>Name:</h4>
                        <p id="insuredName">Loading...</p>
                        <h4 style="margin-top: 15px;">Business Address:</h4>
                        <p id="insuredAddress">Loading...</p>
                    </div>
                </div>

                <!-- Email Field (always visible) -->
                <div class="form-section">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="your.email@example.com">
                        <div class="help-text">Optional. If no email is entered we will use the insured email on file.</div>
                    </div>

                    <!-- Additional email fields container -->
                    <div id="additionalEmailsContainer"></div>

                    <!-- Add recipient button -->
                    <button type="button" id="addRecipientBtn" class="btn-add-recipient" onclick="addEmailRecipient()">
                        <i class="fas fa-plus-circle"></i> Add Another Recipient
                    </button>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="submit" class="btn-submit">
                        <i class="fas fa-paper-plane"></i> Email Certificate
                    </button>
                    <a href="policyholder-dashboard.html" class="btn-cancel">Cancel</a>
                </div>
            </form>

            <!-- Contact Help -->
            <div class="contact-help">
                <h4>Questions?</h4>
                <p style="margin-bottom: 15px;">Our customer service team is here to help.</p>
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-phone"></i>
                        <span>1-844-472-0967</span>
                    </div>
                    <div class="contact-item">
                        <i class="fas fa-envelope"></i>
                        <span>contact@vigagency.com</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <img src="../images/vanguard-logo.png" alt="Vanguard Insurance Group" class="footer-logo">
                    <p>Your trusted partner in commercial trucking insurance.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="../index.html#products">Our Products</a></li>
                        <li><a href="quote-commercial-auto.html">Get a Quote</a></li>
                        <li><a href="../index.html#claims">File a Claim</a></li>
                        <li><a href="../index.html#contact">Contact Us</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Insurance Products</h4>
                    <ul>
                        <li><a href="commercial-auto.html">Commercial Auto</a></li>
                        <li><a href="trucking-insurance.html">Trucking Insurance</a></li>
                        <li><a href="general-liability.html">General Liability</a></li>
                        <li><a href="cargo-insurance.html">Cargo Insurance</a></li>
                        <li><a href="workers-comp.html">Workers' Compensation</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact Info</h4>
                    <p>2888 Nationwide Pkwy<br>Brunswick, OH 44212</p>
                    <p>Phone: (330) 460-0872<br>Email: contact@vigagency.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Vanguard Insurance Group. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Cookie Policy</a>
                </div>
            </div>
        </div>
    </footer>

    <script src="../js/main.js"></script>
    <script src="../js/policy-data.js"></script>
    <script>
        // Toggle tooltip visibility
        function toggleTooltip() {
            const tooltip = document.getElementById('holderTooltip');
            tooltip.classList.toggle('show');
        }

        function closeTooltip() {
            const tooltip = document.getElementById('holderTooltip');
            tooltip.classList.remove('show');
        }

        // Close tooltip when clicking outside
        document.addEventListener('click', function(event) {
            const tooltip = document.getElementById('holderTooltip');
            const infoIcon = document.querySelector('.info-tooltip i');

            if (tooltip && infoIcon && !tooltip.contains(event.target) && event.target !== infoIcon) {
                tooltip.classList.remove('show');
            }
        });

        // Toggle between no fields and subcontractor fields
        function toggleVendorFields() {
            const isVendor = document.getElementById('vendor-yes').checked;
            const subcontractorFields = document.getElementById('subcontractorFields');
            const contactInfoSection = document.getElementById('contactInfoSection');

            if (isVendor) {
                // Show subcontractor fields, hide contact info
                subcontractorFields.classList.remove('hidden');
                contactInfoSection.classList.add('hidden');

                // Add required to subcontractor fields
                document.getElementById('subcontractorName').setAttribute('required', 'required');
                document.getElementById('subcontractorStreet').setAttribute('required', 'required');
            } else {
                // Hide subcontractor fields, show contact info
                subcontractorFields.classList.add('hidden');
                contactInfoSection.classList.remove('hidden');

                // Remove required from subcontractor fields
                document.getElementById('subcontractorName').removeAttribute('required');
                document.getElementById('subcontractorStreet').removeAttribute('required');
            }
        }

        // Track number of additional email fields
        let additionalEmailCount = 0;
        const MAX_ADDITIONAL_EMAILS = 4; // 1 original + 4 additional = 5 total

        // Add email recipient field
        function addEmailRecipient() {
            if (additionalEmailCount >= MAX_ADDITIONAL_EMAILS) return;

            additionalEmailCount++;

            const container = document.getElementById('additionalEmailsContainer');
            const emailGroup = document.createElement('div');
            emailGroup.className = 'additional-email-group';
            emailGroup.id = `email-group-${additionalEmailCount}`;

            emailGroup.innerHTML = `
                <input type="email"
                       id="email${additionalEmailCount}"
                       name="email${additionalEmailCount}"
                       placeholder="recipient${additionalEmailCount}@example.com"
                       style="width: 100%; padding: 12px 16px; border: 2px solid #e1e8ed; border-radius: 8px; font-size: 16px; font-family: 'Inter', sans-serif;">
                <button type="button" class="btn-remove-recipient" onclick="removeEmailRecipient(${additionalEmailCount})">
                    <i class="fas fa-times"></i>
                </button>
            `;

            container.appendChild(emailGroup);

            // Hide the "Add Another Recipient" button if we've reached the max
            if (additionalEmailCount >= MAX_ADDITIONAL_EMAILS) {
                document.getElementById('addRecipientBtn').classList.add('hidden');
            }
        }

        // Remove email recipient field
        function removeEmailRecipient(id) {
            const emailGroup = document.getElementById(`email-group-${id}`);
            if (emailGroup) {
                emailGroup.remove();
                additionalEmailCount--;

                // Show the "Add Another Recipient" button again
                document.getElementById('addRecipientBtn').classList.remove('hidden');
            }
        }

        const API_BASE_URL = ''; // Use same domain (proxy will forward to CRM)
        let currentPolicyId = null;
        let policyData = null;

        // Get policy information from URL parameters
        window.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const policyId = urlParams.get('policy_id');
            const policyNumber = urlParams.get('policy_number');

            currentPolicyId = policyId;

            if (policyNumber) {
                document.getElementById('policyNumber').textContent = policyNumber;
            } else {
                document.getElementById('policyNumber').textContent = 'N/A';
            }

            // Check if user is logged in
            const isLoggedIn = localStorage.getItem('vanguard_logged_in') === 'true';
            const token = localStorage.getItem('vanguard_auth_token');

            if (!isLoggedIn || !token) {
                window.location.href = 'login.html';
                return;
            }

            // Fetch policy details to populate contact information
            fetchPolicyDetails(token);

            // Handle logout
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    localStorage.removeItem('vanguard_logged_in');
                    localStorage.removeItem('vanguard_user_name');
                    localStorage.removeItem('vanguard_policy_number');
                    localStorage.removeItem('vanguard_auth_token');
                    window.location.href = 'login.html';
                });
            }
        });

        async function fetchPolicyDetails(token) {
            try {
                // Use client-side policy database instead of server API
                const policyNumber = localStorage.getItem('vanguard_policy_number');
                if (!policyNumber || !window.policyDB) {
                    console.error('No policy number or policy database available');
                    document.getElementById('insuredName').textContent = 'Policy not found';
                    document.getElementById('insuredAddress').textContent = 'Please return to dashboard';
                    return;
                }

                // Get policy from client-side database
                const policy = window.policyDB.getPolicyByNumber(policyNumber);
                if (!policy) {
                    console.error('Policy not found in database:', policyNumber);
                    document.getElementById('insuredName').textContent = 'Policy not found';
                    document.getElementById('insuredAddress').textContent = 'Please return to dashboard';
                    return;
                }

                // Create client data structure from policy
                const clientData = {
                    name: policy.insured_name,
                    email: policy.client_email,
                    phone: policy.client_phone,
                    address: policy.address
                };

                policyData = {
                    client: clientData,
                    policy: policy
                };

                console.log('Using client-side policy data:', policyData);

                // Update insured name
                const insuredNameEl = document.getElementById('insuredName');
                if (insuredNameEl) {
                    insuredNameEl.textContent = policy.insured_name || 'N/A';
                }

                // Update insured address
                const insuredAddressEl = document.getElementById('insuredAddress');
                if (insuredAddressEl) {
                    if (policy.address) {
                        insuredAddressEl.textContent = policy.address;
                    } else {
                        insuredAddressEl.textContent = 'Address not available in policy';
                    }
                }

            } catch (error) {
                console.error('Error loading policy details from client database:', error);
                document.getElementById('insuredName').textContent = 'Error loading data';
                document.getElementById('insuredAddress').textContent = 'Please try refreshing the page';
            }
        }

        async function submitCOIRequest(event) {
            event.preventDefault();

            const token = localStorage.getItem('vanguard_auth_token');
            const submitButton = document.querySelector('.btn-submit');
            const originalButtonText = submitButton.innerHTML;

            if (!token) {
                alert('Your session has expired. Please log in again.');
                window.location.href = 'login.html';
                return;
            }

            if (!currentPolicyId) {
                alert('Policy ID is missing. Please return to the dashboard and try again.');
                return;
            }

            const isVendor = document.querySelector('input[name="isVendor"]:checked').value === 'yes';

            // Build certificate holder information based on selection
            let certificateHolderText = '';

            if (isVendor) {
                // Collect subcontractor data
                const name = document.getElementById('subcontractorName').value;
                const street = document.getElementById('subcontractorStreet').value;
                const unit = document.getElementById('subcontractorUnit').value;
                const zip = document.getElementById('subcontractorZip').value;
                const city = document.getElementById('subcontractorCity').value;
                const state = document.getElementById('subcontractorState').value;

                // Build address_line1 with street and optional unit
                const address_line1 = street + (unit ? ', ' + unit : '');

                // Format certificate holder as text string (required by new API)
                certificateHolderText = `${name}\n${address_line1}\n${city}, ${state} ${zip}`;
            } else {
                // Use policyholder's own contact information
                if (policyData && policyData.client) {
                    const client = policyData.client;

                    // Build certificate holder text
                    const name = client.name || 'Policyholder';
                    const addressLine1 = client.address || '';

                    let cityStateZip = [];
                    if (client.city) cityStateZip.push(client.city);
                    if (client.state) cityStateZip.push(client.state);
                    if (client.zip) cityStateZip.push(client.zip);

                    const addressLine2 = cityStateZip.join(', ');

                    // Format certificate holder as text string
                    certificateHolderText = `${name}\n${addressLine1}`;
                    if (addressLine2) {
                        certificateHolderText += `\n${addressLine2}`;
                    }
                } else {
                    certificateHolderText = 'As requested\nPer policyholder request';
                }
            }

            // Get all recipient emails
            const recipientEmails = [document.getElementById('email').value || policyData?.client?.email || ''];

            // Collect additional emails
            for (let i = 1; i <= additionalEmailCount; i++) {
                const emailField = document.getElementById(`email${i}`);
                if (emailField && emailField.value) {
                    recipientEmails.push(emailField.value);
                }
            }

            // Filter out empty emails and join with commas
            const allRecipients = recipientEmails.filter(email => email.trim() !== '').join(', ');

            // Build policyData object
            const policyInfo = policyData?.policy || {};
            const clientInfo = policyData?.client || {};

            // NEW API FORMAT: Send to the new stored profile PDF endpoint
            const requestData = {
                to: allRecipients,
                cc: '',
                bcc: '',
                subject: `Certificate of Insurance - ${clientInfo.name || 'Policyholder'} - Policy ${policyInfo.policy_number || 'N/A'}`,
                body: 'Please find attached your Certificate of Insurance.',
                policyData: {
                    policyNumber: policyInfo.policy_number || '',
                    insuredName: clientInfo.name || '',
                    carrier: policyInfo.carrier || '',
                    clientName: clientInfo.name || ''
                },
                certificateHolder: certificateHolderText,
                provider: 'outlook'
            };

            // Log the request data for debugging
            console.log('NEW COI Request Data (using stored profile):', JSON.stringify(requestData, null, 2));

            // Disable button and show loading state
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending COI...';

            try {
                // NEW ENDPOINT: Use the stored profile PDF endpoint (via proxy)
                const response = await fetch(`${API_BASE_URL}/api/coi/send-profile-pdf`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.status === 401 || response.status === 403) {
                    // Token expired or invalid
                    alert('Your session has expired. Please log in again.');
                    localStorage.removeItem('vanguard_logged_in');
                    localStorage.removeItem('vanguard_auth_token');
                    window.location.href = 'login.html';
                    return;
                }

                const data = await response.json();

                if (response.ok && data.success) {
                    // Success
                    alert('Certificate of Insurance sent successfully!\n\n' +
                          (data.message || 'The certificate has been emailed with the stored profile PDF.'));

                    // Redirect back to dashboard
                    setTimeout(() => {
                        window.location.href = 'policyholder-dashboard.html';
                    }, 1000);
                } else {
                    // Error from API
                    alert('Error sending COI:\n\n' + (data.error || 'An unexpected error occurred. Please try again.'));

                    // Re-enable button
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                }
            } catch (error) {
                console.error('COI sending error:', error);
                alert('Connection Error\n\nUnable to connect to the server. Please check your internet connection and try again.\n\nError: ' + error.message);

                // Re-enable button
                submitButton.disabled = false;
                submitButton.innerHTML = originalButtonText;
            }
        }
    </script>
</body>
</html>
